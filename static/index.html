<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IAPN Event Planner</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f4f8; color: #2d3748; min-height: 100vh; }

  /* â”€â”€ Login â”€â”€ */
  #login-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
  }
  .login-box {
    background: white; border-radius: 16px; padding: 48px 40px;
    width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;
  }
  .login-box .logo { font-size: 48px; margin-bottom: 12px; }
  .login-box h1 { font-size: 22px; font-weight: 700; color: #1a365d; margin-bottom: 6px; }
  .login-box p { color: #718096; font-size: 14px; margin-bottom: 32px; }
  .login-box input {
    width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px;
    font-size: 16px; margin-bottom: 16px; outline: none; transition: border-color 0.2s;
    letter-spacing: 2px;
  }
  .login-box input:focus { border-color: #2b6cb0; }
  .login-box button {
    width: 100%; padding: 14px; background: #2b6cb0; color: white; border: none;
    border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s;
  }
  .login-box button:hover { background: #1a365d; }
  .login-error { color: #e53e3e; font-size: 13px; margin-top: 10px; display: none; }

  /* â”€â”€ App Shell â”€â”€ */
  #app { display: none; }

  /* â”€â”€ Header â”€â”€ */
  .header {
    background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
    color: white; padding: 20px 28px; display: flex; align-items: center;
    justify-content: space-between; flex-wrap: wrap; gap: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  }
  .header-left h1 { font-size: 20px; font-weight: 700; }
  .header-left p { font-size: 13px; opacity: 0.8; margin-top: 2px; }
  .header-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .header-controls label { font-size: 13px; opacity: 0.9; }
  .header-controls input[type=number] {
    width: 90px; padding: 8px 10px; border-radius: 8px; border: none;
    font-size: 15px; font-weight: 600; text-align: center; background: rgba(255,255,255,0.2);
    color: white; outline: none;
  }
  .header-controls input[type=number]::placeholder { color: rgba(255,255,255,0.6); }
  .currency-btn {
    padding: 8px 14px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.4);
    background: transparent; color: white; font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
  }
  .currency-btn.active { background: rgba(255,255,255,0.25); border-color: white; }
  .save-status { font-size: 12px; opacity: 0.8; min-width: 120px; text-align: right; }
  .save-status.saving { opacity: 1; color: #ffd700; }
  .save-status.saved { opacity: 1; color: #68d391; }
  .save-status.error { opacity: 1; color: #fc8181; }
  .logout-btn {
    padding: 7px 14px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.4);
    background: transparent; color: white; font-size: 12px; cursor: pointer;
    transition: all 0.2s;
  }
  .logout-btn:hover { background: rgba(255,255,255,0.15); }

  /* â”€â”€ Summary Bar â”€â”€ */
  .summary-bar {
    background: white; padding: 16px 28px; display: flex; gap: 24px;
    flex-wrap: wrap; border-bottom: 1px solid #e2e8f0;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
  .summary-item { text-align: center; }
  .summary-item .val { font-size: 20px; font-weight: 700; color: #1a365d; }
  .summary-item .lbl { font-size: 11px; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
  .summary-item.highlight .val { color: #2b6cb0; }

  /* â”€â”€ Main Layout â”€â”€ */
  .main { display: flex; height: calc(100vh - 130px); overflow: hidden; }

  /* â”€â”€ Event Library â”€â”€ */
  .library {
    width: 280px; min-width: 240px; background: white; border-right: 1px solid #e2e8f0;
    display: flex; flex-direction: column; overflow: hidden;
  }
  .library-header {
    padding: 16px; border-bottom: 1px solid #e2e8f0; background: #f7fafc;
  }
  .library-header h3 { font-size: 13px; font-weight: 700; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; }
  .library-search {
    margin-top: 10px; width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0;
    border-radius: 8px; font-size: 13px; outline: none;
  }
  .library-filter { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
  .filter-btn {
    padding: 4px 10px; border-radius: 20px; border: 1px solid #e2e8f0;
    background: white; font-size: 11px; cursor: pointer; transition: all 0.15s; color: #4a5568;
  }
  .filter-btn.active { background: #2b6cb0; color: white; border-color: #2b6cb0; }
  .library-list { flex: 1; overflow-y: auto; padding: 8px; }
  .lib-event {
    padding: 10px 12px; margin-bottom: 6px; background: #f7fafc; border: 1px solid #e2e8f0;
    border-radius: 8px; cursor: grab; transition: all 0.15s; font-size: 13px;
    border-left: 3px solid #cbd5e0;
  }
  .lib-event:hover { background: #ebf4ff; border-color: #bee3f8; transform: translateX(2px); }
  .lib-event.dragging { opacity: 0.5; }
  .lib-event.cat-food { border-left-color: #f6ad55; }
  .lib-event.cat-venue { border-left-color: #68d391; }
  .lib-event.cat-other { border-left-color: #76e4f7; }
  .lib-event-name { font-weight: 600; color: #2d3748; }
  .lib-event-cost { font-size: 11px; color: #718096; margin-top: 3px; }
  .lib-event-tag {
    display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 10px;
    font-weight: 600; margin-top: 4px; text-transform: uppercase;
  }
  .tag-food { background: #fef3c7; color: #92400e; }
  .tag-venue { background: #d1fae5; color: #065f46; }
  .tag-other { background: #e0f2fe; color: #0c4a6e; }

  /* â”€â”€ Schedule Board â”€â”€ */
  .board { flex: 1; overflow-x: auto; overflow-y: auto; padding: 20px; display: flex; gap: 16px; align-items: flex-start; }

  /* â”€â”€ Day Column â”€â”€ */
  .day-col {
    min-width: 240px; width: 260px; background: white; border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column;
    flex-shrink: 0;
  }
  .day-header {
    padding: 14px 16px; border-bottom: 1px solid #e2e8f0; background: #f7fafc;
    border-radius: 12px 12px 0 0;
  }
  .day-label-input {
    width: 100%; font-size: 14px; font-weight: 700; color: #1a365d; border: none;
    background: transparent; outline: none; padding: 0;
  }
  .day-notes-input {
    width: 100%; font-size: 11px; color: #718096; border: none; background: transparent;
    outline: none; resize: none; margin-top: 4px; font-family: inherit; line-height: 1.4;
  }
  .day-cost {
    font-size: 12px; font-weight: 700; color: #2b6cb0; margin-top: 6px;
    padding-top: 6px; border-top: 1px solid #e2e8f0;
  }
  .day-events {
    flex: 1; padding: 10px; min-height: 120px; transition: background 0.15s;
  }
  .day-events.drag-over { background: #ebf4ff; border-radius: 0 0 12px 12px; }
  .day-events.empty::after {
    content: 'Drop events here'; display: block; text-align: center;
    color: #cbd5e0; font-size: 12px; padding: 20px 0; font-style: italic;
  }
  .day-footer { padding: 10px 16px; border-top: 1px solid #e2e8f0; }
  .remove-day-btn {
    font-size: 11px; color: #e53e3e; background: none; border: none; cursor: pointer;
    opacity: 0.6; transition: opacity 0.2s;
  }
  .remove-day-btn:hover { opacity: 1; }

  /* â”€â”€ Schedule Event Card â”€â”€ */
  .sched-event {
    padding: 10px 12px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0;
    border-radius: 8px; cursor: grab; position: relative; transition: all 0.15s;
    border-left: 3px solid #cbd5e0;
  }
  .sched-event:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); transform: translateY(-1px); }
  .sched-event.dragging { opacity: 0.4; transform: rotate(2deg); }
  .sched-event.cat-food { border-left-color: #f6ad55; }
  .sched-event.cat-venue { border-left-color: #68d391; }
  .sched-event.cat-other { border-left-color: #76e4f7; }
  .sched-event-name { font-size: 13px; font-weight: 600; color: #2d3748; padding-right: 20px; }
  .sched-event-cost { font-size: 11px; color: #718096; margin-top: 3px; }
  .sched-event-desc { font-size: 11px; color: #a0aec0; margin-top: 2px; font-style: italic; }
  .remove-event-btn {
    position: absolute; top: 8px; right: 8px; background: none; border: none;
    color: #cbd5e0; cursor: pointer; font-size: 14px; line-height: 1;
    transition: color 0.15s;
  }
  .remove-event-btn:hover { color: #e53e3e; }

  /* â”€â”€ Add Day Button â”€â”€ */
  .add-day-col {
    min-width: 200px; display: flex; align-items: flex-start; padding-top: 20px;
  }
  .add-day-btn {
    padding: 12px 20px; background: white; border: 2px dashed #cbd5e0; border-radius: 12px;
    color: #718096; font-size: 14px; cursor: pointer; transition: all 0.2s; width: 100%;
  }
  .add-day-btn:hover { border-color: #2b6cb0; color: #2b6cb0; background: #ebf4ff; }

  /* â”€â”€ Scrollbar â”€â”€ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
  ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â• -->
<div id="login-screen">
  <div class="login-box">
    <div class="logo">ğŸ“‹</div>
    <h1>IAPN Event Planner</h1>
    <p>Enter your password to continue</p>
    <input type="password" id="pw-input" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Sign In</button>
    <div class="login-error" id="login-error">Incorrect password. Please try again.</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â• -->
<div id="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>ğŸ“‹ IAPN Event Planner</h1>
      <p id="event-title-display">IAPN 2027 May 21-24</p>
    </div>
    <div class="header-controls">
      <label>Attendees:</label>
      <input type="number" id="attendees-input" value="100" min="1" max="9999" oninput="onAttendeesChange()">
      <button class="currency-btn active" id="btn-hkd" onclick="setCurrency('HKD')">HKD</button>
      <button class="currency-btn" id="btn-usd" onclick="setCurrency('USD')">USD</button>
      <div class="save-status" id="save-status">All changes saved</div>
      <button class="logout-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <!-- Summary Bar -->
  <div class="summary-bar" id="summary-bar">
    <div class="summary-item">
      <div class="val" id="sum-attendees">100</div>
      <div class="lbl">Attendees</div>
    </div>
    <div class="summary-item">
      <div class="val" id="sum-days">4</div>
      <div class="lbl">Days</div>
    </div>
    <div class="summary-item">
      <div class="val" id="sum-events">0</div>
      <div class="lbl">Total Events</div>
    </div>
    <div class="summary-item highlight">
      <div class="val" id="sum-total">HKD 0</div>
      <div class="lbl">Total Est. Cost</div>
    </div>
    <div class="summary-item highlight">
      <div class="val" id="sum-per-person">HKD 0</div>
      <div class="lbl">Per Person</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Library -->
    <div class="library">
      <div class="library-header">
        <h3>Event Library</h3>
        <input class="library-search" type="text" placeholder="Search eventsâ€¦" oninput="filterLibrary(this.value)" id="lib-search">
        <div class="library-filter">
          <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
          <button class="filter-btn" onclick="setFilter('food', this)">ğŸ½ Food</button>
          <button class="filter-btn" onclick="setFilter('venue', this)">ğŸ› Venue</button>
          <button class="filter-btn" onclick="setFilter('other', this)">âœ¨ Other</button>
        </div>
      </div>
      <div class="library-list" id="library-list"></div>
    </div>

    <!-- Board -->
    <div class="board" id="board"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•
let state = null;
let saveTimer = null;
let dragSource = null; // { type: 'library'|'schedule', dayId, eventIndex, event }
let currentFilter = 'all';
let currentSearch = '';
const HKD_TO_USD = 0.128;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•
async function doLogin() {
  const pw = document.getElementById('pw-input').value;
  const err = document.getElementById('login-error');
  err.style.display = 'none';
  try {
    const res = await fetch('/api/login', {
      method: 'POST', credentials: 'include',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({password: pw})
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      await loadData();
    } else {
      err.style.display = 'block';
    }
  } catch(e) {
    err.textContent = 'Connection error. Please try again.';
    err.style.display = 'block';
  }
}

async function doLogout() {
  await fetch('/api/logout', {method: 'POST', credentials: 'include'});
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('pw-input').value = '';
}

async function checkAuth() {
  try {
    const res = await fetch('/api/check-auth', {credentials: 'include'});
    const data = await res.json();
    if (data.authenticated) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      await loadData();
    }
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DATA â•â•â•â•â•â•â•â•
async function loadData() {
  try {
    const res = await fetch('/api/data', {credentials: 'include'});
    if (res.status === 401) return;
    state = await res.json();
    render();
  } catch(e) {
    console.error('Load error:', e);
  }
}

function scheduleSave() {
  setSaveStatus('saving', 'ğŸ’¾ Savingâ€¦');
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveData, 800);
}

async function saveData() {
  try {
    const res = await fetch('/api/data', {
      method: 'POST', credentials: 'include',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(state)
    });
    const data = await res.json();
    if (data.success) {
      const now = new Date();
      const hkt = now.toLocaleTimeString('en-HK', {hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Hong_Kong'});
      setSaveStatus('saved', `âœ… Saved ${hkt} HKT`);
    } else {
      setSaveStatus('error', 'âŒ Save failed');
    }
  } catch(e) {
    setSaveStatus('error', 'âŒ Save failed');
  }
}

function setSaveStatus(cls, msg) {
  const el = document.getElementById('save-status');
  el.className = 'save-status ' + cls;
  el.textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CURRENCY â•â•â•â•
function setCurrency(c) {
  state.currency = c;
  document.getElementById('btn-hkd').className = 'currency-btn' + (c === 'HKD' ? ' active' : '');
  document.getElementById('btn-usd').className = 'currency-btn' + (c === 'USD' ? ' active' : '');
  render();
  scheduleSave();
}

function fmt(hkd) {
  const val = state.currency === 'USD' ? hkd * HKD_TO_USD : hkd;
  const sym = state.currency === 'USD' ? 'USD' : 'HKD';
  return sym + ' ' + Math.round(val).toLocaleString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COST CALC â•â•â•
function calcEventCost(ev, attendees) {
  const perPerson = (ev.perPersonCost || 0) * attendees;
  const min = ev.minimumCost || 0;
  return Math.max(perPerson, min);
}

function calcDayCost(dayId) {
  const events = state.schedule[dayId] || [];
  const att = parseInt(state.attendees) || 100;
  return events.reduce((sum, ev) => sum + calcEventCost(ev, att), 0);
}

function calcTotalCost() {
  return state.days.reduce((sum, d) => sum + calcDayCost(d.id), 0);
}

function totalEvents() {
  return state.days.reduce((sum, d) => sum + (state.schedule[d.id] || []).length, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ATTENDEES â•â•â•
function onAttendeesChange() {
  state.attendees = parseInt(document.getElementById('attendees-input').value) || 100;
  updateSummary();
  updateAllDayCosts();
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•
function render() {
  document.getElementById('attendees-input').value = state.attendees || 100;
  document.getElementById('btn-hkd').className = 'currency-btn' + (state.currency === 'HKD' ? ' active' : '');
  document.getElementById('btn-usd').className = 'currency-btn' + (state.currency === 'USD' ? ' active' : '');
  renderLibrary();
  renderBoard();
  updateSummary();
}

function updateSummary() {
  const att = parseInt(state.attendees) || 100;
  const total = calcTotalCost();
  document.getElementById('sum-attendees').textContent = att;
  document.getElementById('sum-days').textContent = state.days.length;
  document.getElementById('sum-events').textContent = totalEvents();
  document.getElementById('sum-total').textContent = fmt(total);
  document.getElementById('sum-per-person').textContent = att > 0 ? fmt(total / att) : fmt(0);
}

function updateAllDayCosts() {
  state.days.forEach(d => {
    const el = document.getElementById('day-cost-' + d.id);
    if (el) el.textContent = 'Est. Cost: ' + fmt(calcDayCost(d.id));
  });
  updateSummary();
}

// â”€â”€â”€ Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLibrary() {
  const list = document.getElementById('library-list');
  const search = currentSearch.toLowerCase();
  const events = (state.events || []).filter(ev => {
    const matchCat = currentFilter === 'all' || ev.category === currentFilter;
    const matchSearch = !search || ev.name.toLowerCase().includes(search);
    return matchCat && matchSearch;
  });
  list.innerHTML = events.map(ev => {
    const cost = ev.perPersonCost > 0 && ev.minimumCost > 0
      ? `${fmt(ev.perPersonCost)}/person (min ${fmt(ev.minimumCost)})`
      : ev.perPersonCost > 0 ? `${fmt(ev.perPersonCost)}/person`
      : ev.minimumCost > 0 ? `Fixed: ${fmt(ev.minimumCost)}`
      : 'Cost TBD';
    return `<div class="lib-event cat-${ev.category}" draggable="true"
        ondragstart="onLibDragStart(event, ${ev.id})"
        ondragend="onDragEnd(event)">
      <div class="lib-event-name">${ev.name}</div>
      <div class="lib-event-cost">${cost}</div>
      <span class="lib-event-tag tag-${ev.category}">${ev.category}</span>
    </div>`;
  }).join('');
}

function filterLibrary(val) {
  currentSearch = val;
  renderLibrary();
}

function setFilter(cat, btn) {
  currentFilter = cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLibrary();
}

// â”€â”€â”€ Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard() {
  const board = document.getElementById('board');
  const att = parseInt(state.attendees) || 100;
  board.innerHTML = state.days.map(day => {
    const events = state.schedule[day.id] || [];
    const dayCost = calcDayCost(day.id);
    const evCards = events.map((ev, idx) => {
      const cost = calcEventCost(ev, att);
      const costStr = cost > 0 ? fmt(cost) : 'Cost TBD';
      return `<div class="sched-event cat-${ev.category}" draggable="true"
          ondragstart="onSchedDragStart(event, '${day.id}', ${idx})"
          ondragend="onDragEnd(event)">
        <button class="remove-event-btn" onclick="removeEvent('${day.id}', ${idx})">Ã—</button>
        <div class="sched-event-name">${ev.name}</div>
        <div class="sched-event-cost">${costStr}</div>
        ${ev.description ? `<div class="sched-event-desc">${ev.description}</div>` : ''}
      </div>`;
    }).join('');
    return `<div class="day-col" id="daycol-${day.id}">
      <div class="day-header">
        <input class="day-label-input" value="${escHtml(day.label)}"
          oninput="updateDayLabel('${day.id}', this.value)">
        <textarea class="day-notes-input" rows="2"
          oninput="updateDayNotes('${day.id}', this.value)"
          placeholder="Notesâ€¦">${escHtml(day.notes || '')}</textarea>
        <div class="day-cost" id="day-cost-${day.id}">Est. Cost: ${fmt(dayCost)}</div>
      </div>
      <div class="day-events${events.length === 0 ? ' empty' : ''}" id="drop-${day.id}"
        ondragover="onDragOver(event, '${day.id}')"
        ondragleave="onDragLeave(event, '${day.id}')"
        ondrop="onDrop(event, '${day.id}')">
        ${evCards}
      </div>
      <div class="day-footer">
        <button class="remove-day-btn" onclick="removeDay('${day.id}')">ğŸ—‘ Remove day</button>
      </div>
    </div>`;
  }).join('');

  // Add Day button
  board.innerHTML += `<div class="add-day-col">
    <button class="add-day-btn" onclick="addDay()">+ Add Day</button>
  </div>`;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ Day Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addDay() {
  const id = 'day' + state.nextDayId++;
  state.days.push({id, label: 'Day ' + state.nextDayId, notes: ''});
  state.schedule[id] = [];
  renderBoard();
  updateSummary();
  scheduleSave();
}

function removeDay(dayId) {
  if (state.days.length <= 1) return alert('You need at least one day.');
  state.days = state.days.filter(d => d.id !== dayId);
  delete state.schedule[dayId];
  renderBoard();
  updateSummary();
  scheduleSave();
}

function updateDayLabel(dayId, val) {
  const day = state.days.find(d => d.id === dayId);
  if (day) day.label = val;
  scheduleSave();
}

function updateDayNotes(dayId, val) {
  const day = state.days.find(d => d.id === dayId);
  if (day) day.notes = val;
  scheduleSave();
}

// â”€â”€â”€ Event Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function removeEvent(dayId, idx) {
  state.schedule[dayId].splice(idx, 1);
  renderBoard();
  updateSummary();
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRAG & DROP â•â•
function onLibDragStart(e, eventId) {
  const ev = (state.events || []).find(x => x.id === eventId);
  dragSource = {type: 'library', event: ev ? {...ev} : null};
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'copy';
}

function onSchedDragStart(e, dayId, idx) {
  dragSource = {type: 'schedule', dayId, eventIndex: idx, event: {...state.schedule[dayId][idx]}};
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function onDragEnd(e) {
  e.target.classList.remove('dragging');
}

function onDragOver(e, dayId) {
  e.preventDefault();
  e.dataTransfer.dropEffect = dragSource && dragSource.type === 'library' ? 'copy' : 'move';
  const zone = document.getElementById('drop-' + dayId);
  if (zone) zone.classList.add('drag-over');
}

function onDragLeave(e, dayId) {
  const zone = document.getElementById('drop-' + dayId);
  if (zone) zone.classList.remove('drag-over');
}

function onDrop(e, targetDayId) {
  e.preventDefault();
  const zone = document.getElementById('drop-' + targetDayId);
  if (zone) zone.classList.remove('drag-over');
  if (!dragSource || !dragSource.event) return;

  if (dragSource.type === 'library') {
    // Clone from library with unique instance id
    const clone = {...dragSource.event, instanceId: Date.now()};
    state.schedule[targetDayId] = state.schedule[targetDayId] || [];
    state.schedule[targetDayId].push(clone);
  } else if (dragSource.type === 'schedule') {
    const srcDay = dragSource.dayId;
    const srcIdx = dragSource.eventIndex;
    const ev = dragSource.event;
    // Remove from source
    state.schedule[srcDay].splice(srcIdx, 1);
    // Add to target
    state.schedule[targetDayId] = state.schedule[targetDayId] || [];
    state.schedule[targetDayId].push(ev);
  }

  dragSource = null;
  renderBoard();
  updateSummary();
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  document.getElementById('pw-input').focus();
});
</script>
</body>
</html>
